---
// src/components/MapSection.astro
import { accommodationsData, getAmenityIcon, MAPBOX_CONFIG } from '../data/accommodationData.js';
---

<!-- Mapbox GL JS CDN -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<section class="map-section" id="mapa">
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Filter Tabs -->
      <div class="filter-tabs">
        <button class="filter-tab active" data-category="hoteles">
          <svg class="filter-tab-icon" viewBox="0 0 24 24" fill="none">
            <path d="M3 9h18v11a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9z" fill="currentColor"/>
            <path d="M12 3L3 9h18l-9-6z" fill="currentColor" opacity="0.7"/>
            <circle cx="8" cy="14" r="1" fill="#000"/>
            <circle cx="16" cy="14" r="1" fill="#000"/>
          </svg>
          Hoteles
        </button>
        <button class="filter-tab" data-category="departamentos">
          <svg class="filter-tab-icon" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="4" width="18" height="16" rx="2" fill="currentColor"/>
            <rect x="6" y="8" width="3" height="4" fill="#000"/>
            <rect x="11" y="8" width="3" height="4" fill="#000"/>
            <rect x="15" y="8" width="3" height="4" fill="#000"/>
            <rect x="6" y="14" width="3" height="4" fill="#000"/>
            <rect x="11" y="14" width="3" height="4" fill="#000"/>
            <rect x="15" y="14" width="3" height="4" fill="#000"/>
          </svg>
          Apartamentos
        </button>
        <button class="filter-tab" data-category="hostales">
          <svg class="filter-tab-icon" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="6" width="16" height="12" rx="1" fill="currentColor"/>
            <rect x="6" y="9" width="12" height="2" fill="#000"/>
            <rect x="6" y="13" width="12" height="2" fill="#000"/>
            <circle cx="8" cy="4" r="1" fill="currentColor"/>
            <circle cx="12" cy="4" r="1" fill="currentColor"/>
            <circle cx="16" cy="4" r="1" fill="currentColor"/>
          </svg>
          Hostales
        </button>
      </div>

      <!-- Accommodation List -->
      <div class="accommodation-list" id="accommodation-list">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <!-- Search Bar -->
      <div class="search-bar">
        <input type="text" class="search-input" placeholder="Buscar ubicaci√≥n...">
        <button class="search-btn">Buscar</button>
      </div>

      <!-- Map Controls -->
      <div class="map-controls">
        <button class="map-control-btn" id="toggle-style">üó∫Ô∏è</button>
        <button class="map-control-btn" id="center-map">üìç</button>
      </div>

      <!-- Map -->
      <div id="map"></div>
    </div>
  </div>
</section>

<style>
  .map-section {
    min-height: 100vh;
    background: #000;
  }

  .main-container {
    display: flex;
    height: 100vh;
  }

  /* Sidebar */
  .sidebar {
    width: 420px;
    background: #111;
    border-right: 1px solid #333;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .sidebar::-webkit-scrollbar {
    display: none;
  }

  /* Filter Tabs */
  .filter-tabs {
    display: flex;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
  }

  .filter-tab {
    flex: 1;
    padding: 1rem;
    text-align: center;
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    position: relative;
  }

  .filter-tab.active {
    color: #0EA5E9;
    background: #222;
  }

  .filter-tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: #0EA5E9;
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }

  .filter-tab.active::after {
    transform: scaleX(1);
  }

  .filter-tab-icon {
    width: 1.5rem;
    height: 1.5rem;
    margin-bottom: 0.3rem;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  /* Accommodation Cards */
  .accommodation-list {
    padding: 1rem;
  }

  .accommodation-card {
    background: #1a1a1a;
    border-radius: 12px;
    margin-bottom: 1rem;
    overflow: hidden;
    border: 1px solid #333;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
  }

  .accommodation-card:hover {
    border-color: #0EA5E9;
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(14, 165, 233, 0.2);
  }

  .accommodation-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(255, 107, 53, 0.05));
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1;
    pointer-events: none;
  }

  .accommodation-card:hover::before {
    opacity: 1;
  }

  .card-image {
    width: 100%;
    height: 140px;
    object-fit: cover;
    display: block;
    border-radius: 12px 12px 0 0;
    background-color: #333;
  }

  .card-content {
    padding: 1rem;
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .card-header {
    margin-bottom: 1rem;
    width: 100%;
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #fff;
    margin: 0;
    text-align: center;
  }

  /* Iconos de amenidades centrados y m√°s grandes */
  .card-amenities-icons {
    display: flex;
    gap: 1.2rem;
    margin-bottom: 1.2rem;
    align-items: center;
    justify-content: center;
    min-height: 28px;
  }

  .card-amenities-icons svg {
    width: 28px;
    height: 28px;
    color: #0EA5E9;
    flex-shrink: 0;
  }

  .card-footer {
    display: flex;
    justify-content: center;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #333;
    width: 100%;
  }



  .reserve-btn {
    background: #0EA5E9 !important;
    color: #fff !important;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 25px;
    font-weight: bold;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
    margin: 0 auto;
  }

  .reserve-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
  }

  .reserve-btn:hover::before {
    left: 100%;
  }

  .reserve-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(14, 165, 233, 0.5);
    background: #0284c7 !important;
  }

  .reserve-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(14, 165, 233, 0.3);
  }

  /* Map Container */
  .map-container {
    flex: 1;
    position: relative;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  /* Map Controls */
  .map-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .map-control-btn {
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border: 1px solid #333;
    padding: 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .map-control-btn:hover {
    background: #0EA5E9;
    border-color: #0EA5E9;
  }

  /* Search Bar */
  .search-bar {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 100;
    background: rgba(0, 0, 0, 0.9);
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid #333;
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .search-input {
    background: #222;
    border: 1px solid #444;
    color: #fff;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    width: 200px;
  }

  .search-input::placeholder {
    color: #666;
  }

  .search-btn {
    background: #0EA5E9;
    color: #fff;
    border: none;
    padding: 0.7rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
  }

  .search-btn:hover {
    background: #0284c7;
  }

  /* Loading Animation */
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: #666;
  }

  .spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #333;
    border-top: 3px solid #0EA5E9;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Custom Mapbox Popup */
  :global(.mapboxgl-popup-content) {
    background: #1a1a1a !important;
    border: 1px solid #333 !important;
    border-radius: 12px !important;
    color: #fff !important;
    padding: 0 !important;
    width: 180px !important;
  }

  :global(.mapboxgl-popup-tip) {
    border-top-color: #1a1a1a !important;
  }

  .popup-content {
    padding: 0.8rem;
  }

  .popup-image {
    width: 100%;
    height: 60px;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
  }

  .popup-title {
    font-size: 0.9rem;
    font-weight: bold;
    margin: 0.5rem 0;
    color: #fff;
    text-align: center;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .main-container {
      flex-direction: column;
    }
    
    .map-container {
      height: 40vh;
      order: 1;
    }
    
    .sidebar {
      height: 60vh;
      order: 2;
      width: 100%;
      border-right: none;
      border-top: 1px solid #333;
    }

    .search-bar {
      position: relative;
      top: 0;
      left: 0;
      margin: 0.5rem;
      width: calc(100% - 1rem);
      padding: 0.8rem;
    }

    .search-input {
      width: 140px;
      font-size: 0.8rem;
    }
    
    .search-btn {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
    }

    .map-controls {
      top: 10px;
      right: 10px;
      gap: 0.3rem;
    }

    .map-control-btn {
      padding: 0.6rem;
      font-size: 0.9rem;
    }
  }
</style>

<script is:inline define:vars={{ accommodationsData, MAPBOX_CONFIG }}>
// @ts-nocheck
(function() {
  // Variables globales
  let map;
  let markers = [];
  let currentCategory = 'hoteles';

  // Datos pasados desde el servidor
  console.log('accommodationsData:', accommodationsData);
  console.log('MAPBOX_CONFIG:', MAPBOX_CONFIG);

  // getAmenityIcon function (client-side) - Iconos m√°s modernos y atractivos
  function getAmenityIcon(iconType) {
    const iconMap = {
      'üë•': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="#0EA5E9"/>
        <circle cx="12" cy="8" r="2" fill="#fff"/>
      </svg>`,
      'üì∂': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <path d="M2 17h20v2H2zm1.15-4.05L4 11.47l.85 1.48c.39-.67.98-1.23 1.68-1.68l-.85-1.48c-.98.52-1.83 1.26-2.53 2.16zM6.53 9.78l.85 1.48c.68-.39 1.43-.66 2.25-.78V8.5c-1.13.15-2.17.55-3.1 1.28zm3.97 4.22h3l1.5-2.6c-.68-.39-1.43-.66-2.25-.78v1.98h-2.25zm6.47-4.22c-.93-.73-1.97-1.13-3.1-1.28v1.98c.82.12 1.57.39 2.25.78l.85-1.48z" fill="#0EA5E9"/>
        <circle cx="5" cy="16" r="1" fill="#fff"/>
        <circle cx="9" cy="16" r="1" fill="#fff"/>
        <circle cx="13" cy="16" r="1" fill="#fff"/>
        <circle cx="17" cy="16" r="1" fill="#fff"/>
      </svg>`,
      'üèä‚Äç‚ôÇÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <rect x="2" y="8" width="20" height="8" rx="3" fill="#0EA5E9"/>
        <path d="M4 10h16v4H4z" fill="#4FC3F7"/>
        <circle cx="7" cy="12" r="1" fill="#fff" opacity="0.8"/>
        <circle cx="12" cy="12" r="1" fill="#fff" opacity="0.8"/>
        <circle cx="17" cy="12" r="1" fill="#fff" opacity="0.8"/>
        <path d="M6 6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z" fill="#FF6B35"/>
      </svg>`,
      '‚òï': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <path d="M18.5 3H6c-1.1 0-2 .9-2 2v6c0 2.76 2.24 5 5 5h4c2.76 0 5-2.24 5-5v-1h.5c1.38 0 2.5-1.12 2.5-2.5S19.88 5 18.5 5z" fill="#8D6E63"/>
        <path d="M6 5h10v6c0 1.66-1.34 3-3 3H9c-1.66 0-3-1.34-3-3V5z" fill="#A1887F"/>
        <path d="M18.5 7c.28 0 .5-.22.5-.5S18.78 6 18.5 6H18v1h.5z" fill="#6D4C41"/>
        <ellipse cx="11" cy="7" rx="3" ry="1" fill="#FFCCBC" opacity="0.7"/>
      </svg>`,
      'üèÑ‚Äç‚ôÇÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <path d="M2 18h20v2H2z" fill="#0EA5E9"/>
        <path d="M4 16h16c0-2-1-3-2-3H6c-1 0-2 1-2 3z" fill="#4FC3F7"/>
        <rect x="10" y="8" width="4" height="8" rx="1" fill="#FF6B35"/>
        <circle cx="12" cy="6" r="2" fill="#FFAB91"/>
        <path d="M8 14c1-1 2-1 3-1h2c1 0 2 0 3 1" stroke="#0EA5E9" stroke-width="2" fill="none"/>
      </svg>`,
      'üß∫': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <path d="M7 8v10c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H7z" fill="#8D6E63"/>
        <path d="M5 6h14v2H5z" fill="#A1887F"/>
        <rect x="8" y="10" width="8" height="1" fill="#6D4C41"/>
        <rect x="8" y="13" width="8" height="1" fill="#6D4C41"/>
        <rect x="8" y="16" width="8" height="1" fill="#6D4C41"/>
        <circle cx="10" cy="4" r="1" fill="#FF6B35"/>
        <circle cx="14" cy="4" r="1" fill="#FF6B35"/>
      </svg>`,
      'üõÅ': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <path d="M7 8h10v8c0 1.1-.9 2-2 2H9c-1.1 0-2-.9-2-2V8z" fill="#0EA5E9"/>
        <path d="M6 8h12v1H6z" fill="#4FC3F7"/>
        <circle cx="9" cy="12" r="0.5" fill="#fff" opacity="0.7"/>
        <circle cx="12" cy="13" r="0.5" fill="#fff" opacity="0.7"/>
        <circle cx="15" cy="11" r="0.5" fill="#fff" opacity="0.7"/>
        <rect x="4" y="16" width="2" height="4" fill="#8D6E63"/>
        <rect x="18" y="16" width="2" height="4" fill="#8D6E63"/>
      </svg>`,
      'üèãÔ∏è‚Äç‚ôÇÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <rect x="3" y="11" width="18" height="2" fill="#8D6E63"/>
        <rect x="2" y="9" width="3" height="6" rx="1" fill="#FF6B35"/>
        <rect x="19" y="9" width="3" height="6" rx="1" fill="#FF6B35"/>
        <rect x="6" y="10" width="2" height="4" rx="1" fill="#0EA5E9"/>
        <rect x="16" y="10" width="2" height="4" rx="1" fill="#0EA5E9"/>
        <circle cx="12" cy="7" r="1.5" fill="#FFAB91"/>
        <path d="M10 9h4v2h-4z" fill="#4CAF50"/>
      </svg>`,
      'üåÖ': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <circle cx="12" cy="8" r="3" fill="#FFB74D"/>
        <path d="M12 2v2M12 14v2M4.22 6.22l1.42 1.42M18.36 6.22l-1.42 1.42M2 12h2M20 12h2" stroke="#FFB74D" stroke-width="1.5"/>
        <path d="M2 18h20v4H2z" fill="#4CAF50"/>
        <path d="M2 16h20v2H2z" fill="#66BB6A"/>
        <circle cx="7" cy="17" r="0.5" fill="#81C784"/>
        <circle cx="17" cy="17" r="0.5" fill="#81C784"/>
      </svg>`,
      'üç≥': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <circle cx="12" cy="12" r="8" fill="#8D6E63"/>
        <circle cx="12" cy="12" r="6" fill="#A1887F"/>
        <circle cx="12" cy="12" r="3" fill="#FFEB3B"/>
        <circle cx="12" cy="12" r="1.5" fill="#FF9800"/>
        <rect x="18" y="14" width="4" height="2" rx="1" fill="#6D4C41"/>
      </svg>`,
      'üÖøÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
        <rect x="3" y="6" width="18" height="10" rx="2" fill="#0EA5E9"/>
        <circle cx="7" cy="14" r="1.5" fill="#333"/>
        <circle cx="17" cy="14" r="1.5" fill="#333"/>
        <rect x="8" y="8" width="8" height="2" fill="#fff"/>
        <text x="12" y="13" text-anchor="middle" fill="#fff" font-size="6" font-weight="bold">P</text>
      </svg>`
    };
    return iconMap[iconType] || `<svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28"><circle cx="12" cy="12" r="4" fill="#0EA5E9"/></svg>`;
  }

  // Funci√≥n para esperar a que Mapbox se cargue
  function waitForMapbox() {
    return new Promise(function(resolve) {
      if (typeof mapboxgl !== 'undefined') {
        resolve();
      } else {
        const checkMapbox = setInterval(function() {
          if (typeof mapboxgl !== 'undefined') {
            clearInterval(checkMapbox);
            resolve();
          }
        }, 100);
        
        // Timeout despu√©s de 10 segundos
        setTimeout(function() {
          clearInterval(checkMapbox);
          console.error('Timeout waiting for Mapbox');
          resolve();
        }, 10000);
      }
    });
  }

  // Initialize when DOM loads
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, waiting for Mapbox...');
    
    waitForMapbox().then(function() {
      if (typeof mapboxgl !== 'undefined') {
        console.log('Mapbox loaded, initializing map...');
        initMap();
      } else {
        console.error('Mapbox failed to load');
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
          mapContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">Error cargando el mapa. Verifica tu conexi√≥n a internet.</div>';
        }
      }
    });
  });

  // Initialize map
  function initMap() {
    try {
      console.log('Initializing map with config:', MAPBOX_CONFIG);
      
      if (!MAPBOX_CONFIG || !MAPBOX_CONFIG.accessToken) {
        console.error('MAPBOX_CONFIG or accessToken not found');
        return;
      }
      
      mapboxgl.accessToken = MAPBOX_CONFIG.accessToken;
      
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
        console.error('Map container not found');
        return;
      }
      
      map = new mapboxgl.Map({
        container: 'map',
        style: MAPBOX_CONFIG.defaultStyle || 'mapbox://styles/mapbox/dark-v11',
        center: MAPBOX_CONFIG.defaultCenter || [-80.9553, -2.2108],
        zoom: MAPBOX_CONFIG.defaultZoom || 12,
        attributionControl: false
      });

      map.on('load', function() {
        console.log('Map loaded successfully');
        
        // Cargar datos iniciales
        loadAccommodations('hoteles');
        setupEventListeners();
        
        // Redimensionar mapa despu√©s de un momento
        setTimeout(function() {
          if (map) {
            map.resize();
          }
        }, 500);
      });

      map.on('error', function(e) {
        console.error('Map error:', e);
      });

      // Redimensionar mapa en cambio de ventana
      window.addEventListener('resize', function() {
        if (map) {
          setTimeout(function() {
            map.resize();
          }, 100);
        }
      });

    } catch (error) {
      console.error('Error initializing map:', error);
    }
  }

  // Setup event listeners
  function setupEventListeners() {
    // Filter tabs
    const filterTabs = document.querySelectorAll('.filter-tab');
    for (let i = 0; i < filterTabs.length; i++) {
      filterTabs[i].addEventListener('click', function() {
        // Remove active class from all tabs
        for (let j = 0; j < filterTabs.length; j++) {
          filterTabs[j].classList.remove('active');
        }
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        const category = this.getAttribute('data-category');
        if (category) {
          currentCategory = category;
          loadAccommodations(category);
        }
      });
    }

    // Map controls
    const toggleBtn = document.getElementById('toggle-style');
    const centerBtn = document.getElementById('center-map');
    const searchBtn = document.querySelector('.search-btn');
    
    if (toggleBtn) {
      toggleBtn.addEventListener('click', toggleMapStyle);
    }
    
    if (centerBtn) {
      centerBtn.addEventListener('click', centerMap);
    }
    
    if (searchBtn) {
      searchBtn.addEventListener('click', function() {
        const searchInput = document.querySelector('.search-input');
        const query = searchInput ? searchInput.value.trim() : '';
        if (query) {
          console.log('Searching for:', query);
          // Aqu√≠ puedes implementar la funcionalidad de b√∫squeda
        }
      });
    }

    // Enter key para b√∫squeda
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          if (query) {
            console.log('Searching for:', query);
            // Implementar b√∫squeda
          }
        }
      });
    }
  }

  // Load accommodations
  function loadAccommodations(category) {
    console.log('Loading accommodations for category:', category);
    
    if (!accommodationsData || !accommodationsData[category]) {
      console.error('No data found for category:', category);
      const listContainer = document.getElementById('accommodation-list');
      if (listContainer) {
        listContainer.innerHTML = '<div class="loading">No hay datos disponibles</div>';
      }
      return;
    }
    
    const accommodations = accommodationsData[category];
    console.log('Found accommodations:', accommodations.length);
    
    updateAccommodationList(accommodations);
    updateMapMarkers(accommodations);
  }

  // Update accommodation list in sidebar
  function updateAccommodationList(accommodations) {
    const listContainer = document.getElementById('accommodation-list');
    
    if (!listContainer) {
      console.error('Accommodation list container not found');
      return;
    }
    
    if (accommodations.length === 0) {
      listContainer.innerHTML = '<div class="loading">No hay alojamientos disponibles</div>';
      return;
    }

    const accommodationCards = accommodations.map(function(accommodation) {
      const amenityIcons = accommodation.amenities.map(function(amenity) {
        return getAmenityIcon(amenity.icon);
      }).join('');

      return `
        <div class="accommodation-card" onclick="selectAccommodation(${accommodation.id}, true)">
          <img src="${accommodation.image}" alt="${accommodation.name}" class="card-image" loading="lazy">
          <div class="card-content">
            <div class="card-header">
              <h3 class="card-title">${accommodation.name}</h3>
            </div>
            
            <div class="card-amenities-icons">
              ${amenityIcons}
            </div>
            
            <div class="card-footer">
              <button class="reserve-btn" onclick="event.stopPropagation(); window.open('/reservas?id=${accommodation.id}', '_blank')">RESERVAR</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    listContainer.innerHTML = accommodationCards;
  }

  // Update map markers
  function updateMapMarkers(accommodations) {
    if (!map) {
      console.error('Map not initialized');
      return;
    }

    // Remover marcadores existentes
    for (let i = 0; i < markers.length; i++) {
      markers[i].remove();
    }
    markers = [];

    for (let i = 0; i < accommodations.length; i++) {
      const accommodation = accommodations[i];
      const markerColor = currentCategory === 'hoteles' ? '#FF6B35' : 
                        currentCategory === 'departamentos' ? '#0EA5E9' : '#10B981';

      try {
        const popupAmenities = accommodation.amenities.slice(0, 2).map(function(amenity) {
          return `<span>${getAmenityIcon(amenity.icon)}</span>`;
        }).join('');

        const marker = new mapboxgl.Marker({ color: markerColor })
          .setLngLat(accommodation.coordinates)
          .setPopup(
            new mapboxgl.Popup({ offset: 25 })
              .setHTML(`
                <div class="popup-content">
                  <img src="${accommodation.image}" alt="${accommodation.name}" class="popup-image">
                  <h3 class="popup-title">${accommodation.name}</h3>
                </div>
              `)
          )
          .addTo(map);

        markers.push(marker);
      } catch (error) {
        console.error('Error creating marker for accommodation:', accommodation.name, error);
      }
    }

    // Ajustar vista del mapa para mostrar todos los marcadores
    if (accommodations.length > 0) {
      try {
        const bounds = new mapboxgl.LngLatBounds();
        for (let i = 0; i < accommodations.length; i++) {
          bounds.extend(accommodations[i].coordinates);
        }
        map.fitBounds(bounds, { padding: 50 });
      } catch (error) {
        console.error('Error fitting bounds:', error);
      }
    }
  }

  // Select accommodation
  function selectAccommodation(id, autoFocus) {
    autoFocus = autoFocus || false;
    
    const allAccommodations = []
      .concat(accommodationsData.hoteles || [])
      .concat(accommodationsData.departamentos || [])
      .concat(accommodationsData.hostales || []);
    
    let accommodation = null;
    for (let i = 0; i < allAccommodations.length; i++) {
      if (allAccommodations[i].id === id) {
        accommodation = allAccommodations[i];
        break;
      }
    }
    
    if (accommodation && map) {
      if (autoFocus) {
        // Scroll to map section
        const mapSection = document.querySelector('#mapa');
        if (mapSection) {
          mapSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
        
        // Fly to location after scroll
        setTimeout(function() {
          map.flyTo({
            center: accommodation.coordinates,
            zoom: 16,
            duration: 2500,
            essential: true
          });
        }, 800);
      } else {
        map.flyTo({
          center: accommodation.coordinates,
          zoom: 16,
          duration: 2000
        });
      }
      
      // Show popup
      setTimeout(function() {
        for (let i = 0; i < markers.length; i++) {
          const marker = markers[i];
          const lngLat = marker.getLngLat();
          if (Math.abs(lngLat.lng - accommodation.coordinates[0]) < 0.001 && 
              Math.abs(lngLat.lat - accommodation.coordinates[1]) < 0.001) {
            const popup = marker.getPopup();
            if (popup) {
              popup.addTo(map);
            }
            break;
          }
        }
      }, autoFocus ? 3000 : 2000);
    }
  }

  // Map controls
  function toggleMapStyle() {
    if (!map) return;
    
    try {
      const currentStyle = map.getStyle().name;
      const newStyle = currentStyle === 'Mapbox Dark' ? 
        'mapbox://styles/mapbox/streets-v12' : 
        'mapbox://styles/mapbox/dark-v11';
      map.setStyle(newStyle);
    } catch (error) {
      console.error('Error toggling map style:', error);
    }
  }

  function centerMap() {
    if (!map || !accommodationsData[currentCategory]) return;
    
    const accommodations = accommodationsData[currentCategory];
    if (accommodations.length > 0) {
      try {
        const bounds = new mapboxgl.LngLatBounds();
        for (let i = 0; i < accommodations.length; i++) {
          bounds.extend(accommodations[i].coordinates);
        }
        map.fitBounds(bounds, { padding: 50 });
      } catch (error) {
        console.error('Error centering map:', error);
      }
    }
  }

  // Get directions function
  function getDirections(lng, lat) {
    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
    window.open(googleMapsUrl, '_blank');
  }

  // Make functions global so they can be called from HTML
  window.selectAccommodation = selectAccommodation;
  window.toggleMapStyle = toggleMapStyle;
  window.centerMap = centerMap;
  window.getDirections = getDirections;

})();
</script>