---
// src/components/MapSection.astro
import { accommodationsData, getAmenityIcon, MAPBOX_CONFIG } from '../data/accommodationData.js';
---

<!-- Mapbox GL JS CDN -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<section class="map-section" id="mapa">
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Filter Tabs -->
      <div class="filter-tabs">
        <button class="filter-tab active" data-category="hoteles">
          <svg class="filter-tab-icon" viewBox="0 0 24 24" fill="none">
            <path d="M3 9h18v11a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9z" fill="currentColor"/>
            <path d="M12 3L3 9h18l-9-6z" fill="currentColor" opacity="0.7"/>
            <circle cx="8" cy="14" r="1" fill="#000"/>
            <circle cx="16" cy="14" r="1" fill="#000"/>
          </svg>
          Hoteles
        </button>
        <button class="filter-tab" data-category="departamentos">
          <svg class="filter-tab-icon" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="4" width="18" height="16" rx="2" fill="currentColor"/>
            <rect x="6" y="8" width="3" height="4" fill="#000"/>
            <rect x="11" y="8" width="3" height="4" fill="#000"/>
            <rect x="15" y="8" width="3" height="4" fill="#000"/>
            <rect x="6" y="14" width="3" height="4" fill="#000"/>
            <rect x="11" y="14" width="3" height="4" fill="#000"/>
            <rect x="15" y="14" width="3" height="4" fill="#000"/>
          </svg>
          Apartamentos
        </button>
        <button class="filter-tab" data-category="hostales">
          <svg class="filter-tab-icon" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="6" width="16" height="12" rx="1" fill="currentColor"/>
            <rect x="6" y="9" width="12" height="2" fill="#000"/>
            <rect x="6" y="13" width="12" height="2" fill="#000"/>
            <circle cx="8" cy="4" r="1" fill="currentColor"/>
            <circle cx="12" cy="4" r="1" fill="currentColor"/>
            <circle cx="16" cy="4" r="1" fill="currentColor"/>
          </svg>
          Hostales
        </button>
      </div>

      <!-- Accommodation List -->
      <div class="accommodation-list" id="accommodation-list">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <!-- Search Bar -->
      <div class="search-bar">
        <input type="text" class="search-input" placeholder="Buscar ubicaci√≥n...">
        <button class="search-btn">Buscar</button>
      </div>

      <!-- Map Controls -->
      <div class="map-controls">
        <button class="map-control-btn" id="toggle-style">üó∫Ô∏è</button>
        <button class="map-control-btn" id="center-map">üìç</button>
      </div>

      <!-- Map -->
      <div id="map"></div>
    </div>
  </div>
</section>

<style>
  .map-section {
    min-height: 100vh;
    background: #000;
  }

  .main-container {
    display: flex;
    height: 100vh;
  }

  /* Sidebar */
  .sidebar {
    width: 420px;
    background: #111;
    border-right: 1px solid #333;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .sidebar::-webkit-scrollbar {
    display: none;
  }

  /* Filter Tabs */
  .filter-tabs {
    display: flex;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
  }

  .filter-tab {
    flex: 1;
    padding: 1rem;
    text-align: center;
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    position: relative;
  }

  .filter-tab.active {
    color: #0EA5E9;
    background: #222;
  }

  .filter-tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: #0EA5E9;
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }

  .filter-tab.active::after {
    transform: scaleX(1);
  }

  .filter-tab-icon {
    width: 1.5rem;
    height: 1.5rem;
    margin-bottom: 0.3rem;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  /* Accommodation Cards */
  .accommodation-list {
    padding: 1rem;
  }

  .accommodation-card {
    background: #1a1a1a;
    border-radius: 12px;
    margin-bottom: 1rem;
    overflow: hidden;
    border: 1px solid #333;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
  }

  .accommodation-card:hover {
    border-color: #0EA5E9;
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(14, 165, 233, 0.2);
  }

  .accommodation-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(255, 107, 53, 0.05));
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1;
    pointer-events: none;
  }

  .accommodation-card:hover::before {
    opacity: 1;
  }

  .card-image {
    width: 100%;
    height: 140px;
    object-fit: cover;
    display: block;
    border-radius: 12px 12px 0 0;
    background-color: #333;
  }

  .card-content {
    padding: 1rem;
    position: relative;
    z-index: 2;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #fff;
    margin: 0;
    flex: 1;
    text-align: center;
  }

  .card-rating {
    background: #0EA5E9;
    color: #fff;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: bold;
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 3;
  }

  .card-location {
    color: #888;
    font-size: 0.85rem;
    margin-bottom: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.3rem;
  }

  .card-amenities-icons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    align-items: center;
    justify-content: center;
  }

  .card-amenities-icons svg {
    width: 18px;
    height: 18px;
    color: #0EA5E9;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #333;
    gap: 1rem;
  }

  .price-container {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .price {
    font-size: 1.6rem;
    font-weight: bold;
    color: #0EA5E9;
    line-height: 1;
    margin: 0;
  }

  .price::before {
    content: '$';
    font-size: 1.2rem;
    margin-right: 0.1rem;
  }

  .price-per-night {
    font-size: 0.75rem;
    color: #888;
    font-weight: normal;
    margin-top: 0.2rem;
  }

  .reserve-btn {
    background: linear-gradient(135deg, #FF6B35 0%, #FF8E53 100%);
    color: #fff;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 25px;
    font-weight: bold;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
  }

  .reserve-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
  }

  .reserve-btn:hover::before {
    left: 100%;
  }

  .reserve-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.5);
    background: linear-gradient(135deg, #FF8E53 0%, #FFB366 100%);
  }

  .reserve-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
  }

  /* Map Container */
  .map-container {
    flex: 1;
    position: relative;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  /* Map Controls */
  .map-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .map-control-btn {
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border: 1px solid #333;
    padding: 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .map-control-btn:hover {
    background: #0EA5E9;
    border-color: #0EA5E9;
  }

  /* Search Bar */
  .search-bar {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 100;
    background: rgba(0, 0, 0, 0.9);
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid #333;
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .search-input {
    background: #222;
    border: 1px solid #444;
    color: #fff;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    width: 200px;
  }

  .search-input::placeholder {
    color: #666;
  }

  .search-btn {
    background: #0EA5E9;
    color: #fff;
    border: none;
    padding: 0.7rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
  }

  .search-btn:hover {
    background: #0284c7;
  }

  /* Loading Animation */
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: #666;
  }

  .spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #333;
    border-top: 3px solid #0EA5E9;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Custom Mapbox Popup */
  :global(.mapboxgl-popup-content) {
    background: #1a1a1a !important;
    border: 1px solid #333 !important;
    border-radius: 12px !important;
    color: #fff !important;
    padding: 0 !important;
    width: 280px !important;
  }

  :global(.mapboxgl-popup-tip) {
    border-top-color: #1a1a1a !important;
  }

  .popup-content {
    padding: 1rem;
  }

  .popup-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
  }

  .popup-title {
    font-size: 1rem;
    font-weight: bold;
    margin: 0.5rem 0 0.3rem 0;
    color: #fff;
  }

  .popup-price {
    color: #0EA5E9;
    font-weight: bold;
    font-size: 1.1rem;
  }

  .popup-amenities {
    display: flex;
    gap: 0.8rem;
    margin: 0.5rem 0;
    font-size: 0.8rem;
    color: #ccc;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .main-container {
      flex-direction: column;
    }
    
    .map-container {
      height: 40vh;
      order: 1;
    }
    
    .sidebar {
      height: 60vh;
      order: 2;
      width: 100%;
      border-right: none;
      border-top: 1px solid #333;
    }

    .search-bar {
      position: relative;
      top: 0;
      left: 0;
      margin: 0.5rem;
      width: calc(100% - 1rem);
      padding: 0.8rem;
    }

    .search-input {
      width: 140px;
      font-size: 0.8rem;
    }
    
    .search-btn {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
    }

    .map-controls {
      top: 10px;
      right: 10px;
      gap: 0.3rem;
    }

    .map-control-btn {
      padding: 0.6rem;
      font-size: 0.9rem;
    }
  }
</style>

<script is:inline define:vars={{ accommodationsData, MAPBOX_CONFIG }}>
// @ts-nocheck
(function() {
  // Variables globales
  let map;
  let markers = [];
  let currentCategory = 'hoteles';

  // Datos pasados desde el servidor
  console.log('accommodationsData:', accommodationsData);
  console.log('MAPBOX_CONFIG:', MAPBOX_CONFIG);

  // getAmenityIcon function (client-side)
  function getAmenityIcon(iconType) {
    const iconMap = {
      'üë•': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0ZM12 14a7 7 0 0 0-7 7h14a7 7 0 0 0-7-7Z"/>
      </svg>`,
      'üì∂': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M1 9l2 2c2.88-2.88 7.12-2.88 10 0l2-2C9.12 3.12 6.88 3.12 1 9zm8 8l3 3 3-3c-1.65-1.65-4.34-1.65-6 0zm-4-4l2 2c1.23-1.23 3.77-1.23 5 0l2-2C9.46 8.46 6.54 8.46 5 13z"/>
      </svg>`,
      'üèä‚Äç‚ôÇÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M6 14c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm4.5-7C9.57 7 9 7.57 9 8.5S9.57 10 10.5 10s1.5-.57 1.5-1.5S11.43 7 10.5 7zM19 6H5C3.9 6 3 6.9 3 8v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H5V8h14v8z"/>
      </svg>`,
      '‚òï': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M18.5 3H6c-1.1 0-2 .9-2 2v5.71c0 3.83 2.95 7.18 6.78 7.29 3.96.12 7.22-3.06 7.22-7v-1h.5c1.93 0 3.5-1.57 3.5-3.5S20.43 3 18.5 3zM16 10c0 2.76-2.24 5-5 5s-5-2.24-5-5V5h10v5zm2.5-3H18V5h.5c.83 0 1.5.67 1.5 1.5S19.33 7 18.5 7z"/>
      </svg>`,
      'üèÑ‚Äç‚ôÇÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M21 6c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2s2-.9 2-2V8c0-1.1-.9-2-2-2zM7 6c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2s2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
      </svg>`,
      'üß∫': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v3.5c0 .28.22.5.5.5s.5-.22.5-.5V8h10v2.5c0 .28.22.5.5.5s.5-.22.5-.5z"/>
      </svg>`,
      'üõÅ': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M7 7h10v1c0 .55.45 1 1 1s1-.45 1-1V6c0-.55-.45-1-1-1h-1V4c0-.55-.45-1-1-1s-1 .45-1 1v1H9V4c0-.55-.45-1-1-1s-1 .45-1 1v1H6c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1s1-.45 1-1V7z"/>
      </svg>`,
      'üèãÔ∏è‚Äç‚ôÇÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29l-1.43-1.43z"/>
      </svg>`,
      'üåÖ': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/>
      </svg>`,
      'üç≥': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>`,
      'üÖøÔ∏è': `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
      </svg>`
    };
    return iconMap[iconType] || `<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><circle cx="12" cy="12" r="4"/></svg>`;
  }

  // Funci√≥n para esperar a que Mapbox se cargue
  function waitForMapbox() {
    return new Promise(function(resolve) {
      if (typeof mapboxgl !== 'undefined') {
        resolve();
      } else {
        const checkMapbox = setInterval(function() {
          if (typeof mapboxgl !== 'undefined') {
            clearInterval(checkMapbox);
            resolve();
          }
        }, 100);
        
        // Timeout despu√©s de 10 segundos
        setTimeout(function() {
          clearInterval(checkMapbox);
          console.error('Timeout waiting for Mapbox');
          resolve();
        }, 10000);
      }
    });
  }

  // Initialize when DOM loads
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, waiting for Mapbox...');
    
    waitForMapbox().then(function() {
      if (typeof mapboxgl !== 'undefined') {
        console.log('Mapbox loaded, initializing map...');
        initMap();
      } else {
        console.error('Mapbox failed to load');
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
          mapContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">Error cargando el mapa. Verifica tu conexi√≥n a internet.</div>';
        }
      }
    });
  });

  // Initialize map
  function initMap() {
    try {
      console.log('Initializing map with config:', MAPBOX_CONFIG);
      
      if (!MAPBOX_CONFIG || !MAPBOX_CONFIG.accessToken) {
        console.error('MAPBOX_CONFIG or accessToken not found');
        return;
      }
      
      mapboxgl.accessToken = MAPBOX_CONFIG.accessToken;
      
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
        console.error('Map container not found');
        return;
      }
      
      map = new mapboxgl.Map({
        container: 'map',
        style: MAPBOX_CONFIG.defaultStyle || 'mapbox://styles/mapbox/dark-v11',
        center: MAPBOX_CONFIG.defaultCenter || [-80.9553, -2.2108],
        zoom: MAPBOX_CONFIG.defaultZoom || 12,
        attributionControl: false
      });

      map.on('load', function() {
        console.log('Map loaded successfully');
        
        // Cargar datos iniciales
        loadAccommodations('hoteles');
        setupEventListeners();
        
        // Redimensionar mapa despu√©s de un momento
        setTimeout(function() {
          if (map) {
            map.resize();
          }
        }, 500);
      });

      map.on('error', function(e) {
        console.error('Map error:', e);
      });

      // Redimensionar mapa en cambio de ventana
      window.addEventListener('resize', function() {
        if (map) {
          setTimeout(function() {
            map.resize();
          }, 100);
        }
      });

    } catch (error) {
      console.error('Error initializing map:', error);
    }
  }

  // Setup event listeners
  function setupEventListeners() {
    // Filter tabs
    const filterTabs = document.querySelectorAll('.filter-tab');
    for (let i = 0; i < filterTabs.length; i++) {
      filterTabs[i].addEventListener('click', function() {
        // Remove active class from all tabs
        for (let j = 0; j < filterTabs.length; j++) {
          filterTabs[j].classList.remove('active');
        }
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        const category = this.getAttribute('data-category');
        if (category) {
          currentCategory = category;
          loadAccommodations(category);
        }
      });
    }

    // Map controls
    const toggleBtn = document.getElementById('toggle-style');
    const centerBtn = document.getElementById('center-map');
    const searchBtn = document.querySelector('.search-btn');
    
    if (toggleBtn) {
      toggleBtn.addEventListener('click', toggleMapStyle);
    }
    
    if (centerBtn) {
      centerBtn.addEventListener('click', centerMap);
    }
    
    if (searchBtn) {
      searchBtn.addEventListener('click', function() {
        const searchInput = document.querySelector('.search-input');
        const query = searchInput ? searchInput.value.trim() : '';
        if (query) {
          console.log('Searching for:', query);
          // Aqu√≠ puedes implementar la funcionalidad de b√∫squeda
        }
      });
    }

    // Enter key para b√∫squeda
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          if (query) {
            console.log('Searching for:', query);
            // Implementar b√∫squeda
          }
        }
      });
    }
  }

  // Load accommodations
  function loadAccommodations(category) {
    console.log('Loading accommodations for category:', category);
    
    if (!accommodationsData || !accommodationsData[category]) {
      console.error('No data found for category:', category);
      const listContainer = document.getElementById('accommodation-list');
      if (listContainer) {
        listContainer.innerHTML = '<div class="loading">No hay datos disponibles</div>';
      }
      return;
    }
    
    const accommodations = accommodationsData[category];
    console.log('Found accommodations:', accommodations.length);
    
    updateAccommodationList(accommodations);
    updateMapMarkers(accommodations);
  }

  // Update accommodation list in sidebar
  function updateAccommodationList(accommodations) {
    const listContainer = document.getElementById('accommodation-list');
    
    if (!listContainer) {
      console.error('Accommodation list container not found');
      return;
    }
    
    if (accommodations.length === 0) {
      listContainer.innerHTML = '<div class="loading">No hay alojamientos disponibles</div>';
      return;
    }

    const accommodationCards = accommodations.map(function(accommodation) {
      const amenityIcons = accommodation.amenities.map(function(amenity) {
        return getAmenityIcon(amenity.icon);
      }).join('');

      return `
        <div class="accommodation-card" onclick="selectAccommodation(${accommodation.id}, true)">
          <img src="${accommodation.image}" alt="${accommodation.name}" class="card-image" loading="lazy">
          <div class="card-rating">${accommodation.rating}</div>
          <div class="card-content">
            <div class="card-header">
              <h3 class="card-title">${accommodation.name}</h3>
            </div>
            
            <div class="card-location">${accommodation.location}</div>
            
            <div class="card-amenities-icons">
              ${amenityIcons}
            </div>
            
            <div class="card-footer">
              <div class="price-container">
                <span class="price">${accommodation.price}</span>
                <span class="price-per-night">por noche</span>
              </div>
              <button class="reserve-btn" onclick="event.stopPropagation(); window.open('/reservas?id=${accommodation.id}', '_blank')">RESERVAR</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    listContainer.innerHTML = accommodationCards;
  }

  // Update map markers
  function updateMapMarkers(accommodations) {
    if (!map) {
      console.error('Map not initialized');
      return;
    }

    // Remover marcadores existentes
    for (let i = 0; i < markers.length; i++) {
      markers[i].remove();
    }
    markers = [];

    for (let i = 0; i < accommodations.length; i++) {
      const accommodation = accommodations[i];
      const markerColor = currentCategory === 'hoteles' ? '#FF6B35' : 
                        currentCategory === 'departamentos' ? '#0EA5E9' : '#10B981';

      try {
        const popupAmenities = accommodation.amenities.slice(0, 2).map(function(amenity) {
          return `<span>${getAmenityIcon(amenity.icon)}</span>`;
        }).join('');

        const marker = new mapboxgl.Marker({ color: markerColor })
          .setLngLat(accommodation.coordinates)
          .setPopup(
            new mapboxgl.Popup({ offset: 25 })
              .setHTML(`
                <div class="popup-content">
                  <img src="${accommodation.image}" alt="${accommodation.name}" class="popup-image">
                  <h3 class="popup-title">${accommodation.name}</h3>
                  <div class="popup-amenities">
                    ${popupAmenities}
                  </div>
                  <div class="popup-price">${accommodation.price}/noche</div>
                </div>
              `)
          )
          .addTo(map);

        markers.push(marker);
      } catch (error) {
        console.error('Error creating marker for accommodation:', accommodation.name, error);
      }
    }

    // Ajustar vista del mapa para mostrar todos los marcadores
    if (accommodations.length > 0) {
      try {
        const bounds = new mapboxgl.LngLatBounds();
        for (let i = 0; i < accommodations.length; i++) {
          bounds.extend(accommodations[i].coordinates);
        }
        map.fitBounds(bounds, { padding: 50 });
      } catch (error) {
        console.error('Error fitting bounds:', error);
      }
    }
  }

  // Select accommodation
  function selectAccommodation(id, autoFocus) {
    autoFocus = autoFocus || false;
    
    const allAccommodations = []
      .concat(accommodationsData.hoteles || [])
      .concat(accommodationsData.departamentos || [])
      .concat(accommodationsData.hostales || []);
    
    let accommodation = null;
    for (let i = 0; i < allAccommodations.length; i++) {
      if (allAccommodations[i].id === id) {
        accommodation = allAccommodations[i];
        break;
      }
    }
    
    if (accommodation && map) {
      if (autoFocus) {
        // Scroll to map section
        const mapSection = document.querySelector('#mapa');
        if (mapSection) {
          mapSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
        
        // Fly to location after scroll
        setTimeout(function() {
          map.flyTo({
            center: accommodation.coordinates,
            zoom: 16,
            duration: 2500,
            essential: true
          });
        }, 800);
      } else {
        map.flyTo({
          center: accommodation.coordinates,
          zoom: 16,
          duration: 2000
        });
      }
      
      // Show popup
      setTimeout(function() {
        for (let i = 0; i < markers.length; i++) {
          const marker = markers[i];
          const lngLat = marker.getLngLat();
          if (Math.abs(lngLat.lng - accommodation.coordinates[0]) < 0.001 && 
              Math.abs(lngLat.lat - accommodation.coordinates[1]) < 0.001) {
            const popup = marker.getPopup();
            if (popup) {
              popup.addTo(map);
            }
            break;
          }
        }
      }, autoFocus ? 3000 : 2000);
    }
  }

  // Map controls
  function toggleMapStyle() {
    if (!map) return;
    
    try {
      const currentStyle = map.getStyle().name;
      const newStyle = currentStyle === 'Mapbox Dark' ? 
        'mapbox://styles/mapbox/streets-v12' : 
        'mapbox://styles/mapbox/dark-v11';
      map.setStyle(newStyle);
    } catch (error) {
      console.error('Error toggling map style:', error);
    }
  }

  function centerMap() {
    if (!map || !accommodationsData[currentCategory]) return;
    
    const accommodations = accommodationsData[currentCategory];
    if (accommodations.length > 0) {
      try {
        const bounds = new mapboxgl.LngLatBounds();
        for (let i = 0; i < accommodations.length; i++) {
          bounds.extend(accommodations[i].coordinates);
        }
        map.fitBounds(bounds, { padding: 50 });
      } catch (error) {
        console.error('Error centering map:', error);
      }
    }
  }

  // Get directions function
  function getDirections(lng, lat) {
    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
    window.open(googleMapsUrl, '_blank');
  }

  // Make functions global so they can be called from HTML
  window.selectAccommodation = selectAccommodation;
  window.toggleMapStyle = toggleMapStyle;
  window.centerMap = centerMap;
  window.getDirections = getDirections;

})();
</script>